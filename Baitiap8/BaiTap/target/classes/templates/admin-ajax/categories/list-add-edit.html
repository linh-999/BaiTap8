<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin-ajax/layout/layout_admin.html}">
<head>
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/css/bootstrap.min.css"
	rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>

<link
	href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css"
	rel="stylesheet" />
<link
	href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css"
	rel="stylesheet" />
<script
	src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script
	src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
</head>
<body layout:fragment="content">
	<section class="row">
		<div class="col mt-4">
			<div class="container my-3">
				<button id="btnAddCategory" class="btn btn-success">Thêm
					mới danh mục</button>
			</div>

			<div id="message-alert" class="alert alert-primary" role="alert"
				style="display: none;"></div>

			<div class="card">
				<div class="card-header">List Category with Modal</div>
				<div class="card-body">
					<table id="categoryTable" class="table table-striped">
						<thead>
							<tr>
								<th>STT</th>
								<th>Icon</th>
								<th>Tên danh mục</th>
								<th>Hành động</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
						<tfoot>
							<tr>
								<th>STT</th>
								<th>Icon</th>
								<th>Tên danh mục</th>
								<th>Hành động</th>
							</tr>
						</tfoot>
					</table>
				</div>
			</div>
		</div>
	</section>

	<div class="modal fade" id="categoryModal" tabindex="-1"
		aria-labelledby="categoryModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="categoryModalLabel"></h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="categoryForm" enctype="multipart/form-data">
						<input type="hidden" id="categoryId">
						<div class="mb-3">
							<label for="categoryName" class="form-label">Tên danh mục</label>
							<input type="text" class="form-control" id="categoryName"
								required>
						</div>
						<div class="mb-3">
							<label for="iconFile" class="form-label">Icon</label> <input
								type="file" class="form-control" id="iconFile">
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Đóng</button>
					<button type="button" class="btn btn-primary" id="saveCategoryBtn">Lưu</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="deleteModal" tabindex="-1"
		aria-labelledby="deleteModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">Bạn có chắc chắn muốn xóa danh mục
					này?</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Hủy</button>
					<button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
				</div>
			</div>
		</div>
	</div>

	<script>
        let dataTable;

  
        function showMessage(message, type = 'alert-primary') {
            const alertDiv = $('#message-alert');
            alertDiv.removeClass('alert-primary alert-success alert-danger').addClass(type).text(message).fadeIn();
            setTimeout(() => {
                alertDiv.fadeOut();
            }, 3000);
        }


        function loadCategories() {
            $.ajax({
                url: '/api/admin/categories',
                type: 'GET',
                success: function(data) {
        
                    if ($.fn.DataTable.isDataTable('#categoryTable')) {
                        dataTable.destroy();
                    }

                    const tbody = $('#categoryTable tbody');
                    tbody.empty(); 

                    data.forEach((cate, index) => {
                        const row = `
                            <tr>
                                <td>${index + 1}</td>
                                <td><img height="150" width="200" src="/images/category/${cate.icon}" /></td>
                                <td>${cate.categoryName}</td>
                                <td>
                                    <button class="btn btn-sm btn-info btn-edit" data-id="${cate.categoryId}">Sửa</button>
                                    <button class="btn btn-sm btn-danger btn-delete" data-id="${cate.categoryId}">Xóa</button>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                    
               
                    dataTable = $('#categoryTable').DataTable({
                        "paging": true,
                        "ordering": true,
                        "info": true,
                    });
                },
                error: function(error) {
                    showMessage("Lỗi khi tải dữ liệu: " + error.responseText, 'alert-danger');
                }
            });
        }

        $(document).ready(function() {
            loadCategories();

        
            $('#btnAddCategory').click(function() {
                $('#categoryForm')[0].reset(); 
                $('#categoryModalLabel').text('Thêm mới danh mục');
                $('#categoryId').val('');
                $('#categoryModal').modal('show');
            });

          
            $('#saveCategoryBtn').click(function(e) {
                e.preventDefault();
                const categoryId = $('#categoryId').val();
                const categoryName = $('#categoryName').val();
                const iconFile = $('#iconFile')[0].files[0];

                const formData = new FormData();
                formData.append('categoryName', categoryName);
                if (iconFile) {
                    formData.append('iconFile', iconFile);
                }

                if (categoryId) { // Sửa
                    $.ajax({
                        url: `/api/admin/categories/${categoryId}`,
                        type: 'PUT',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(data) {
                            $('#categoryModal').modal('hide');
                            showMessage("Cập nhật danh mục thành công!", 'alert-success');
                            loadCategories();
                        },
                        error: function(error) {
                            showMessage("Cập nhật danh mục thất bại: " + error.responseText, 'alert-danger');
                        }
                    });
                } else { // Thêm mới
                    $.ajax({
                        url: '/api/admin/categories',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(data) {
                            $('#categoryModal').modal('hide');
                            showMessage("Thêm mới danh mục thành công!", 'alert-success');
                            loadCategories();
                        },
                        error: function(error) {
                            showMessage("Thêm mới danh mục thất bại: " + error.responseText, 'alert-danger');
                        }
                    });
                }
            });

            //  "Sửa"
            $(document).on('click', '.btn-edit', function() {
                const categoryId = $(this).data('id');
                $.ajax({
                    url: `/api/admin/categories/${categoryId}`,
                    type: 'GET',
                    success: function(data) {
                        $('#categoryForm')[0].reset();
                        $('#categoryModalLabel').text('Chỉnh sửa danh mục');
                        $('#categoryId').val(data.categoryId);
                        $('#categoryName').val(data.categoryName);
              
                        $('#categoryModal').modal('show');
                    },
                    error: function(error) {
                        showMessage("Không tìm thấy danh mục để sửa: " + error.responseText, 'alert-danger');
                    }
                });
            });

            // "Xóa"
            $(document).on('click', '.btn-delete', function() {
                const categoryId = $(this).data('id');
                $('#confirmDeleteBtn').data('id', categoryId); 
                $('#deleteModal').modal('show');
            });

            // "Xóa" trong modal xác nhận
            $('#confirmDeleteBtn').click(function() {
                const categoryId = $(this).data('id');
                $.ajax({
                    url: `/api/admin/categories/${categoryId}`,
                    type: 'DELETE',
                    success: function() {
                        $('#deleteModal').modal('hide');
                        showMessage("Xóa danh mục thành công!", 'alert-success');
                        loadCategories();
                    },
                    error: function(error) {
                        showMessage("Xóa danh mục thất bại: " + error.responseText, 'alert-danger');
                    }
                });
            });
        });
    </script>
</body>
</html>